Sean Morton
ME333
Homework 9

Chapter 28: 28.4.10 #5

28.4.10 PI Current Control and ITEST Mode
In this section you will implement menu items “g” (Set current gains), “h” (Get current
gains), and “k” (Test current control).

The PI current controller tries to make the current sensor reading match a reference current by
adjusting the PWM signal. For details about PI controllers, see Chapters 23 and 27.2.2.
In this section we focus particularly on the ITEST mode in the 5 kHz current control ISR.

1. Implement the menu items “g” (Set current gains) and “h” (Get current gains) to set
and read the current loop’s proportional and integral gains. You can use either Voating
point or integer gains. Verify the menu items by setting and reading some gains.

_____

2. In the 5 kHz current control ISR, add a case to the switch-case to handle the ITEST mode.
When in ITEST mode, the following should happen in the ISR:

• In this mode, the current controller attempts to track a ±200 mA 100 Hz square wave
reference current (Figure 28.4). Since a half-cycle of a 100 Hz signal is 5 ms, and 5 ms
at 5000 samples/s is 25 samples, this means that the reference current toggles between
+200 and −200 mA every 25 times through the ISR. To implement two full cycles
of the current reference, you could use a static int variable in the ISR that counts
from 0 to 99. At 25, 50, and 75, the reference current changes sign. When the counter
reaches 99, the PIC32 mode should be changed to IDLE—the current loop test is over.

• A PI controller reads the current sensor, compares it to the square wave reference, 
and calculates a new PWM duty cycle and motor direction bit.

• The reference and actual current data are saved in arrays for later plotting (e.g., Figure 28.4).

_____

3. Add the menu item “k” (Test current gains). This puts the PIC32 in ITEST mode,
triggering the ITEST case in the switch-case in the current control ISR. When the PIC32
returns to IDLE mode, indicating that the ITEST has completed, the data saved during the
ITEST should be sent back to the client for plotting (e.g., Figure 28.4). This data transfer
should not occur in an ISR, as it will be slow. See below for sample MATLAB code for
plotting the ITEST data.


4. Experiment by setting different current gains (“g”) and testing them with the square wave
reference current (“k”). Verify that the measured current is approximately zero if both PI
gains are zero. See how good a response you can get with a proportional gain only.
Finally, get the best response possible using both the P and I gains.


5. Turn in your best ITEST plot, and indicate the control gains you used, as well as
their units.